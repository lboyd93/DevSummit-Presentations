<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>GeoJSONLayer</title>

    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      #appContainer {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
      }
      #viewDiv {
        flex: 1;
        width: 100%;
      }
      .container {
        display: flex;
        flex: 1;
        width: 100%;
      }
      .esri-legend .esri-legend__layer-caption {
        display: none;
      }
      .popupSpan {
        color: #0079c1;
        font-weight: bold;
      }
      #legend {
        width: 260px;
      }
      #feature-table-switch {
        padding: 0.5em;
      }
    </style>

    <script
      type="module"
      src="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.69/calcite.esm.js"
    ></script>
    <script
      nomodule=""
      src="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.69/calcite.js"
    ></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.69/calcite.css"
    />

    <link
      rel="stylesheet"
      href="https://jsdev.arcgis.com/4.23/esri/themes/light/main.css"
    />
    <script src="https://jsdev.arcgis.com/4.23/"></script>

    <script>
      require([
        "esri/Map",
        "esri/layers/GeoJSONLayer",
        "esri/views/MapView",
        "esri/layers/support/Field",
        "esri/widgets/Legend",
        "esri/layers/FeatureLayer",
        "esri/smartMapping/renderers/type",
        "esri/widgets/FeatureTable",
      ], (
        Map,
        GeoJSONLayer,
        MapView,
        Field,
        Legend,
        FeatureLayer,
        typeRendererCreator,
        FeatureTable
      ) => {
        const firesURL =
          "https://laurenb.esri.com/DevSummit/2022/GeoJSON-Demo/data/FirePerimeters.geojson";

        const fireTemplate = {
          title: "{FIRE_NAME} Wildfire",
          content: formatContent,
          outFields: ["*"],
          fieldInfos: [
            {
              fieldName: "FIRE_NAME",
              label: "Incident Name",
            },
            {
              fieldName: "GIS_ACRES",
              label: "Acres Burned",
              format: {
                places: 0,
                digitSeparator: true,
              },
            },
            {
              fieldName: "CONT_DATE",
              label: "Contained Date",
            },
            {
              fieldName: "ALARM_DATE",
              label: "Start Date",
            },
            {
              fieldName: "CAUSE",
              label: "Fire Cause",
            },
          ],
        };

        // formats the popup template content
        function formatContent(feature) {
          let fire_name = feature.graphic.attributes.FIRE_NAME;
          let start_date = new Date(feature.graphic.attributes.ALARM_DATE);
          let end_date = new Date(feature.graphic.attributes.CONT_DATE);
          return (
            fire_name +
            " burned <b>{GIS_ACRES}</b> acres of land from <span class='popupSpan'>" +
            start_date.toLocaleString() +
            "</span> until <span class='popupSpan'>" +
            end_date.toLocaleString() +
            "</span>."
          );
        }

        const fireLayer = new GeoJSONLayer({
          url: firesURL,
          copyright:
            "State of California and the Department of Forestry and Fire Protection",
          popupTemplate: fireTemplate,
          orderBy: [
            {
              field: "YEAR_",
            },
          ],
          title: "California Fire Perimeters"
        });

        const states = new FeatureLayer({
          url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_States_Generalized/FeatureServer/0",
          definitionExpression: "STATE_NAME = 'California'",
          opacity: 1,
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-fill",
              color: [10, 86, 160, 0.4],
              outline: {
                // autocasts as new SimpleLineSymbol()
                width: 1,
                color: "white",
              },
            },
          },
          effect: "drop-shadow(-10px, 10px, 6px gray)",
        });

        const map = new Map({
          layers: [states, fireLayer],
          basemap: "gray-vector",
        });

        const view = new MapView({
          container: "viewDiv",
          extent: {
            type: "extent",
            xmin: -13961980.792761113,
            ymin: 3774234.6804606593,
            xmax: -12639192.111282196,
            ymax: 5214430.898644948,
            spatialReference: { wkid: 102100 },
          },
          map: map,
        });

        fireLayer.when(() => {
          // visualization based on categorical field
          let typeParams = {
            layer: fireLayer,
            view: view,
            field: "YEAR_",
            sortBy: "value",
          };

          // when the promise resolves, apply the visual variables to the renderer
          typeRendererCreator
            .createRenderer(typeParams)
            .then(function (response) {
              fireLayer.renderer = response.renderer;
            });

          const query = fireLayer.createQuery();
          query.where = "1=1";
          query.outFields = ["*"];
          // Get a range domain associated with the first feature
          // returned from queryFeatures().
          fireLayer.queryFeatures(query).then(function (results) {
            const domain = fireLayer.getFieldDomain("UNIT_ID", {
              feature: results.features[0],
            });
            console.log("domain", domain);
          });
        });

        const legend = new Legend({
          view,
          layerInfos: [
            {
              title: "California Fire Perimeters",
              layer: fireLayer,
            },
          ],
          container: "legend",
        });
        view.ui.add(legend, "top-right");

        // Typical usage for FeatureTable widget. This will recognize all fields in the layer if none are set.
        const featureTable = new FeatureTable({
          view, // The view property must be set for the select/highlight to work
          layer: fireLayer,
          container: "container", //document.createElement("div")
          
        });
        const appContainer = document.getElementById("appContainer");
        const tableContainer = document.getElementById("container");
        const featuretableSwitch = document.getElementById(
          "feature-table-switch"
        );
        // Don't initially display the FeatureTable
        appContainer.removeChild(tableContainer);
        featuretableSwitch.addEventListener("calciteSwitchChange", (evt) => {
          toggleFeatureTable();
        });

        function toggleFeatureTable() {
          // Check if the table is displayed, if so, toggle off. If not, display.
          if (!featuretableSwitch.checked) {
            appContainer.removeChild(tableContainer);
          } else {
            appContainer.appendChild(tableContainer);
          }
        }

        const sortOrder = document.getElementById("sort-order");
        const ascText = "Sort features with older fires on top";
        const descText = "Sort features with newer fires on top";
        // logic for toggling ascending and descending order
        sortOrder.addEventListener("click", () => {
          // Add query to zoom to relevant extent
          const targetFireQuery = fireLayer.createQuery();
          targetFireQuery.where = "FIRE_NAME = 'HENNESSEY'";
          targetFireQuery.returnGeometry = true;
          fireLayer.queryFeatures(targetFireQuery).then((results) => {
            view.goTo(results.features[0].geometry);
          });

          const order =
            fireLayer.orderBy[0].order === "ascending"
              ? "descending"
              : "ascending";

          fireLayer.orderBy = [
            {
              field: "YEAR_",
              order,
            },
          ];

          // toggles ui icon and description for the sortOrder button
          if (order === "ascending") {
            sortOrder.text = descText;
            sortOrder.icon = `sort-descending-arrow`;
          } else {
            sortOrder.text = ascText;
            sortOrder.icon = `sort-ascending-arrow`;
          }
        });
      });
    </script>
  </head>

  <body>
    <div id="appContainer">
      <div id="viewDiv"></div>
      <div id="legend">
        <calcite-action
          active
          id="sort-order"
          text="Sort features with older fires on top"
          text-enabled
          title="Sort Features"
          icon="sort-ascending-arrow"
          scale="s"
        ></calcite-action>
        <calcite-label layout="inline" id="switch-label"
          ><calcite-switch id="feature-table-switch" scale="l"></calcite-switch>
          <h4 aria-level="3">Display Feature Table</h4>
        </calcite-label>
      </div>
      <div class="container" id="container">
        <div id="tableDiv"></div>
      </div>
    </div>
  </body>
</html>
